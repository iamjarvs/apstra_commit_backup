<!DOCTYPE html>
<html>
<head>
<title>README.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* a11y-dark theme */
/* Based on the Tomorrow Night Eighties theme: https://github.com/isagalaev/highlight.js/blob/master/src/styles/tomorrow-night-eighties.css */
/* @author: ericwbailey */

/* Comment */
.hljs-comment,
.hljs-quote {
  color: #d4d0ab;
}

/* Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
  color: #ffa07a;
}

/* Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
  color: #f5ab35;
}

/* Yellow */
.hljs-attribute {
  color: #ffd700;
}

/* Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
  color: #abe338;
}

/* Blue */
.hljs-title,
.hljs-section {
  color: #00e0e0;
}

/* Purple */
.hljs-keyword,
.hljs-selector-tag {
  color: #dcc6e0;
}

.hljs {
  display: block;
  overflow-x: auto;
  background: #2b2b2b;
  color: #f8f8f2;
  padding: 0.5em;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}

@media screen and (-ms-high-contrast: active) {
  .hljs-addition,
  .hljs-attribute,
  .hljs-built_in,
  .hljs-builtin-name,
  .hljs-bullet,
  .hljs-comment,
  .hljs-link,
  .hljs-literal,
  .hljs-meta,
  .hljs-number,
  .hljs-params,
  .hljs-string,
  .hljs-symbol,
  .hljs-type,
  .hljs-quote {
        color: highlight;
    }

    .hljs-keyword,
    .hljs-selector-tag {
        font-weight: bold;
    }
}

</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="apstra-api-polling-and-backup-tool">Apstra API Polling and Backup Tool</h1>
<p>A robust utility that monitors Apstra API endpoints for changes across multiple blueprints and triggers backups when changes are detected, with secure transfer to remote storage.</p>
<h2 id="features">Features</h2>
<ul>
<li><strong>Multi-Blueprint Support</strong>: Monitor multiple Apstra blueprints simultaneously</li>
<li><strong>Periodic Polling</strong>: Configurable polling intervals for each blueprint</li>
<li><strong>Change Detection</strong>: Identifies new revisions based on revision IDs</li>
<li><strong>Automated Backups</strong>: Triggers backup script when changes are detected</li>
<li><strong>Remote Transfer</strong>: Securely transfers backup files to remote storage</li>
<li><strong>Flexible Authentication</strong>: Supports password and SSH key authentication</li>
<li><strong>Comprehensive Logging</strong>: Detailed logs for monitoring and troubleshooting</li>
<li><strong>State Management</strong>: Persistent tracking of blueprint states across restarts</li>
<li><strong>Docker Support</strong>: Easy containerization with provided Dockerfile</li>
</ul>
<h2 id="installation">Installation</h2>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>Python 3.8 or higher</li>
<li>pip package manager</li>
<li>Access to an Apstra server</li>
<li>Remote storage server (for backup transfers)</li>
</ul>
<h3 id="basic-installation">Basic Installation</h3>
<ol>
<li>
<p>Clone the repository:</p>
<pre class="hljs"><code><div>git <span class="hljs-built_in">clone</span> https://github.com/yourusername/apstra-api-backup-tool.git
<span class="hljs-built_in">cd</span> apstra-api-backup-tool
</div></code></pre>
</li>
<li>
<p>Install the requirements:</p>
<pre class="hljs"><code><div>pip install -r requirements.txt
</div></code></pre>
</li>
<li>
<p>Copy the example environment file:</p>
<pre class="hljs"><code><div>cp .env.example .env
</div></code></pre>
</li>
<li>
<p>Update the <code>.env</code> file with your credentials:</p>
<pre class="hljs"><code><div># Apstra API credentials
APSTRA_USERNAME=admin
APSTRA_PASSWORD=your_password

# Remote server credentials
REMOTE_USERNAME=backup_user
REMOTE_PASSWORD=your_remote_password
# Or use SSH key authentication
# SSH_KEY_PATH=/path/to/private_key
</div></code></pre>
</li>
<li>
<p>Update the configuration in <code>app/config/config.yaml</code></p>
</li>
</ol>
<h2 id="configuration">Configuration</h2>
<p>Configuration is handled through a combination of the <code>config.yaml</code> file and environment variables.</p>
<h3 id="environment-variables">Environment Variables</h3>
<p>Two methods are supported for providing environment variables:</p>
<ol>
<li><strong>System environment variables</strong></li>
<li><strong><code>.env</code> file</strong> in the project root directory</li>
</ol>
<h4 id="required-environment-variables">Required Environment Variables</h4>
<ul>
<li><code>APSTRA_USERNAME</code>: Username for Apstra API authentication</li>
<li><code>APSTRA_PASSWORD</code>: Password for Apstra API authentication</li>
</ul>
<h4 id="optional-environment-variables">Optional Environment Variables</h4>
<ul>
<li><code>REMOTE_USERNAME</code>: Username for remote server</li>
<li><code>REMOTE_PASSWORD</code>: Password for remote server (for password authentication)</li>
<li><code>SSH_KEY_PATH</code>: Path to SSH key file (for key-based authentication)</li>
<li><code>SSH_KEY_PASSPHRASE</code>: Passphrase for SSH key if it's protected</li>
</ul>
<h3 id="configuration-file">Configuration File</h3>
<p>The configuration file (<code>app/config/config.yaml</code>) contains settings for:</p>
<h4 id="multi-blueprint-configuration">Multi-Blueprint Configuration</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># API Configuration</span>
<span class="hljs-attr">api:</span>
  <span class="hljs-attr">server:</span> <span class="hljs-string">"10.28.143.3"</span>
  <span class="hljs-attr">polling_interval_seconds:</span> <span class="hljs-number">30</span>
  
  <span class="hljs-comment"># Multiple blueprints configuration</span>
  <span class="hljs-attr">blueprints:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">"494c107b-3620-4be1-9ffc-1ffc8611482b"</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">"DataCenter-1"</span>  <span class="hljs-comment"># Optional friendly name</span>
      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"/api/blueprints/494c107b-3620-4be1-9ffc-1ffc8611482b/revisions"</span>
      
    <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">"5a7e309c-4521-4af2-8971-12b96c5adef8"</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">"DataCenter-2"</span>  <span class="hljs-comment"># Optional friendly name</span>
      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"/api/blueprints/5a7e309c-4521-4af2-8971-12b96c5adef8/revisions"</span>

<span class="hljs-attr">backup:</span>
  <span class="hljs-attr">script_path:</span> <span class="hljs-string">"/usr/sbin/aos_backup"</span>
  <span class="hljs-attr">parameters:</span> <span class="hljs-string">[]</span>
  
<span class="hljs-attr">transfer:</span>
  <span class="hljs-attr">method:</span> <span class="hljs-string">"scp"</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"backup.example.com"</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
  <span class="hljs-attr">remote_directory:</span> <span class="hljs-string">"/backups/apstra/"</span>
</div></code></pre>
<p>Each blueprint requires:</p>
<ul>
<li><code>id</code>: The UUID of the blueprint (used for identification and backup parameters)</li>
<li><code>endpoint</code>: The API endpoint to poll for this blueprint</li>
</ul>
<p>Optional fields:</p>
<ul>
<li><code>name</code>: A friendly name for the blueprint (used in logs and filenames)</li>
</ul>
<h2 id="usage">Usage</h2>
<h3 id="running-the-application">Running the Application</h3>
<pre class="hljs"><code><div>python app/main.py
</div></code></pre>
<p>With custom configuration and environment files:</p>
<pre class="hljs"><code><div>python app/main.py --config /path/to/custom-config.yaml --env-file /path/to/.env
</div></code></pre>
<h3 id="command-line-options">Command Line Options</h3>
<ul>
<li><code>--config PATH</code>: Path to custom configuration file</li>
<li><code>--env-file PATH</code>: Path to custom .env file</li>
</ul>
<h2 id="how-it-works">How It Works</h2>
<h3 id="polling-process">Polling Process</h3>
<ol>
<li>The application authenticates with the Apstra server using the provided credentials</li>
<li>For each configured blueprint:
<ul>
<li>The API endpoint is polled for revision information</li>
<li>The latest revision is compared with the last known revision</li>
<li>If a new revision is detected, the backup process is triggered</li>
</ul>
</li>
</ol>
<h3 id="backup-process">Backup Process</h3>
<ol>
<li>When changes are detected in a blueprint, the backup script is called with the blueprint ID</li>
<li>The backup script creates a snapshot of the blueprint configuration</li>
<li>The path to the backup file is extracted from the script output</li>
<li>The backup file is transferred to the remote server</li>
</ol>
<h3 id="file-transfer">File Transfer</h3>
<p>Backup files are transferred to the remote server with filenames that include:</p>
<ul>
<li>The blueprint name (or ID if no name is provided)</li>
<li>A timestamp</li>
<li>The file extension</li>
</ul>
<p>Example: <code>DataCenter-1-20250508_101530-aos.data.tar.gz</code></p>
<h3 id="state-management">State Management</h3>
<p>The application maintains state about each blueprint in a JSON file:</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"last_poll_time"</span>: <span class="hljs-string">"2025-05-08T10:15:30.123456"</span>,
  <span class="hljs-attr">"last_updated"</span>: <span class="hljs-string">"2025-05-08T10:15:30.123456"</span>,
  <span class="hljs-attr">"blueprints"</span>: {
    <span class="hljs-attr">"494c107b-3620-4be1-9ffc-1ffc8611482b"</span>: {
      <span class="hljs-attr">"last_revision_id"</span>: <span class="hljs-string">"123"</span>,
      <span class="hljs-attr">"last_poll_time"</span>: <span class="hljs-string">"2025-05-08T10:15:30.123456"</span>,
      <span class="hljs-attr">"blueprint_id"</span>: <span class="hljs-string">"494c107b-3620-4be1-9ffc-1ffc8611482b"</span>,
      <span class="hljs-attr">"blueprint_name"</span>: <span class="hljs-string">"DataCenter-1"</span>
    },
    <span class="hljs-attr">"5a7e309c-4521-4af2-8971-12b96c5adef8"</span>: {
      <span class="hljs-attr">"last_revision_id"</span>: <span class="hljs-string">"456"</span>,
      <span class="hljs-attr">"last_poll_time"</span>: <span class="hljs-string">"2025-05-08T10:15:25.123456"</span>,
      <span class="hljs-attr">"blueprint_id"</span>: <span class="hljs-string">"5a7e309c-4521-4af2-8971-12b96c5adef8"</span>, 
      <span class="hljs-attr">"blueprint_name"</span>: <span class="hljs-string">"DataCenter-2"</span>
    }
  }
}
</div></code></pre>
<h2 id="advanced-configuration">Advanced Configuration</h2>
<h3 id="full-configuration-reference">Full Configuration Reference</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># API Configuration</span>
<span class="hljs-attr">api:</span>
  <span class="hljs-comment"># Apstra server address (without http/https)</span>
  <span class="hljs-attr">server:</span> <span class="hljs-string">"10.28.143.3"</span>
  <span class="hljs-comment"># Polling interval in seconds</span>
  <span class="hljs-attr">polling_interval_seconds:</span> <span class="hljs-number">30</span>
  <span class="hljs-comment"># Custom headers (optional)</span>
  <span class="hljs-attr">headers:</span>
    <span class="hljs-attr">Content-Type:</span> <span class="hljs-string">"application/json"</span>
    <span class="hljs-attr">Accept:</span> <span class="hljs-string">"application/json"</span>
  <span class="hljs-comment"># API request timeout in seconds (optional)</span>
  <span class="hljs-attr">timeout:</span> <span class="hljs-number">10</span>
  <span class="hljs-comment"># Whether to verify SSL certificates (optional)</span>
  <span class="hljs-attr">verify_ssl:</span> <span class="hljs-literal">false</span>
  
  <span class="hljs-comment"># Multiple blueprints configuration</span>
  <span class="hljs-attr">blueprints:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">"494c107b-3620-4be1-9ffc-1ffc8611482b"</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">"DataCenter-1"</span>
      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"/api/blueprints/494c107b-3620-4be1-9ffc-1ffc8611482b/revisions"</span>
    
    <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">"5a7e309c-4521-4af2-8971-12b96c5adef8"</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">"DataCenter-2"</span>
      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"/api/blueprints/5a7e309c-4521-4af2-8971-12b96c5adef8/revisions"</span>

<span class="hljs-comment"># Backup Configuration</span>
<span class="hljs-attr">backup:</span>
  <span class="hljs-comment"># Path to the backup script</span>
  <span class="hljs-attr">script_path:</span> <span class="hljs-string">"/usr/sbin/aos_backup"</span>
  <span class="hljs-comment"># Additional parameters to pass to the script (optional)</span>
  <span class="hljs-attr">parameters:</span> <span class="hljs-string">["--full",</span> <span class="hljs-string">"--compress"</span><span class="hljs-string">]</span>
  <span class="hljs-comment"># Timeout for backup script execution in seconds (optional)</span>
  <span class="hljs-attr">timeout:</span> <span class="hljs-number">600</span>
  <span class="hljs-comment"># Working directory for the backup script (optional)</span>
  <span class="hljs-attr">working_dir:</span> <span class="hljs-string">"/path/to/working/dir"</span>
  <span class="hljs-comment"># Environment variables to pass to the backup script (optional)</span>
  <span class="hljs-attr">env:</span>
    <span class="hljs-attr">BACKUP_LEVEL:</span> <span class="hljs-string">"full"</span>
    <span class="hljs-attr">COMPRESSION:</span> <span class="hljs-string">"gzip"</span>

<span class="hljs-comment"># Remote Transfer Configuration</span>
<span class="hljs-attr">transfer:</span>
  <span class="hljs-comment"># Transfer method: scp, sftp, or ftp</span>
  <span class="hljs-attr">method:</span> <span class="hljs-string">"scp"</span>
  <span class="hljs-comment"># Remote server hostname or IP</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"backup.example.com"</span>
  <span class="hljs-comment"># Remote server port (default: 22 for scp/sftp, 21 for ftp)</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
  <span class="hljs-comment"># Directory on the remote server where backups will be stored</span>
  <span class="hljs-attr">remote_directory:</span> <span class="hljs-string">"/backups/apstra/"</span>
  <span class="hljs-comment"># Number of retry attempts for failed transfers (optional)</span>
  <span class="hljs-attr">retry_attempts:</span> <span class="hljs-number">3</span>
  <span class="hljs-comment"># Delay between retry attempts in seconds (optional)</span>
  <span class="hljs-attr">retry_delay:</span> <span class="hljs-number">5</span>
  <span class="hljs-comment"># Additional SCP options (optional, only for SCP method)</span>
  <span class="hljs-attr">scp_options:</span> <span class="hljs-string">["-C",</span> <span class="hljs-string">"-o"</span><span class="hljs-string">,</span> <span class="hljs-string">"ConnectTimeout=10"</span><span class="hljs-string">]</span>
  <span class="hljs-comment"># Whether to create remote directory if it doesn't exist (optional)</span>
  <span class="hljs-attr">create_remote_dir:</span> <span class="hljs-literal">true</span>
  <span class="hljs-comment"># Timeout for transfer operations in seconds (optional)</span>
  <span class="hljs-attr">timeout:</span> <span class="hljs-number">300</span>
  <span class="hljs-comment"># Whether to keep the local backup file after transfer (optional)</span>
  <span class="hljs-attr">keep_local:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment"># State Management</span>
<span class="hljs-attr">state:</span>
  <span class="hljs-comment"># Path to the state file (stores the last seen revision ID)</span>
  <span class="hljs-attr">file_path:</span> <span class="hljs-string">"data/backup_state.json"</span>
  <span class="hljs-comment"># Backup state file after each update (optional)</span>
  <span class="hljs-attr">backup_state:</span> <span class="hljs-literal">true</span>
  <span class="hljs-comment"># Maximum number of state backups to keep (optional)</span>
  <span class="hljs-attr">max_backups:</span> <span class="hljs-number">5</span>

<span class="hljs-comment"># Logging</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-comment"># Logging level: DEBUG, INFO, WARNING, ERROR, CRITICAL</span>
  <span class="hljs-attr">level:</span> <span class="hljs-string">"INFO"</span>
  <span class="hljs-comment"># Log file path</span>
  <span class="hljs-attr">file:</span> <span class="hljs-string">"logs/backup_service.log"</span>
  <span class="hljs-comment"># Maximum log file size in bytes before rotation (optional)</span>
  <span class="hljs-attr">max_size:</span> <span class="hljs-number">10485760</span>  <span class="hljs-comment"># 10 MB</span>
  <span class="hljs-comment"># Number of backup logs to keep (optional)</span>
  <span class="hljs-attr">backup_count:</span> <span class="hljs-number">5</span>
  <span class="hljs-comment"># Log format (optional)</span>
  <span class="hljs-attr">format:</span> <span class="hljs-string">"%(asctime)s - %(name)s - %(levelname)s - %(message)s"</span>
  <span class="hljs-comment"># Whether to log to console as well (optional)</span>
  <span class="hljs-attr">console:</span> <span class="hljs-literal">true</span>
  <span class="hljs-comment"># Console log level (optional, can be different from file log level)</span>
  <span class="hljs-attr">console_level:</span> <span class="hljs-string">"INFO"</span>
</div></code></pre>
<h3 id="transfer-method-examples">Transfer Method Examples</h3>
<h4 id="scp-transfer-with-password">SCP Transfer (with password)</h4>
<pre class="hljs"><code><div><span class="hljs-attr">transfer:</span>
  <span class="hljs-attr">method:</span> <span class="hljs-string">"scp"</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"backup.example.com"</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
  <span class="hljs-attr">remote_directory:</span> <span class="hljs-string">"/backups/apstra/"</span>
</div></code></pre>
<p><strong>Required Environment Variables:</strong></p>
<pre class="hljs"><code><div>REMOTE_USERNAME=backup_user
REMOTE_PASSWORD=your_remote_password
</div></code></pre>
<h4 id="scp-transfer-with-ssh-key">SCP Transfer (with SSH key)</h4>
<pre class="hljs"><code><div><span class="hljs-attr">transfer:</span>
  <span class="hljs-attr">method:</span> <span class="hljs-string">"scp"</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">"backup.example.com"</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">22</span>
  <span class="hljs-attr">remote_directory:</span> <span class="hljs-string">"/backups/apstra/"</span>
</div></code></pre>
<p><strong>Required Environment Variables:</strong></p>
<pre class="hljs"><code><div>REMOTE_USERNAME=backup_user
SSH_KEY_PATH=/home/user/.ssh/id_rsa
# Optional passphrase if key is protected
SSH_KEY_PASSPHRASE=your_key_passphrase
</div></code></pre>
<h2 id="backup-script">Backup Script</h2>
<p>The backup script is called when changes are detected. The application passes the blueprint ID as a parameter to the script, which should:</p>
<ol>
<li>Perform the backup operation for the specified blueprint</li>
<li>Output the path to the backup file with a format that can be parsed by the application</li>
<li>Return exit code 0 on success</li>
</ol>
<p>Sample output format:</p>
<pre class="hljs"><code><div>New AOS snapshot: snapshot-20250508-101530
</div></code></pre>
<h2 id="logging">Logging</h2>
<p>Logs are written to both stdout and a log file specified in the configuration.</p>
<p>Default log location: <code>logs/backup_service.log</code></p>
<p>Log example:</p>
<pre class="hljs"><code><div>2025-05-08 10:15:30,123 - app.main - INFO - Starting API polling and backup service
2025-05-08 10:15:31,456 - app.services.api_poller - INFO - Successfully authenticated to Apstra API
2025-05-08 10:15:32,789 - app.services.api_poller - INFO - Polling blueprint: DataCenter-1 (494c107b-3620-4be1-9ffc-1ffc8611482b)
2025-05-08 10:15:33,012 - app.services.api_poller - INFO - New revision detected: 124 (previous: 123)
2025-05-08 10:15:33,345 - app.main - INFO - Changes detected in blueprint: DataCenter-1 (494c107b-3620-4be1-9ffc-1ffc8611482b)
</div></code></pre>
<h2 id="best-practices">Best Practices</h2>
<ol>
<li>
<p><strong>Security</strong>:</p>
<ul>
<li>Keep sensitive information in environment variables, not in configuration files</li>
<li>Use SSH key authentication rather than passwords when possible</li>
<li>Run the application with minimal required permissions</li>
</ul>
</li>
<li>
<p><strong>Monitoring</strong>:</p>
<ul>
<li>Set up monitoring for the application's log file</li>
<li>Configure alerts for backup failures</li>
<li>Periodically verify that backups are being created and transferred</li>
</ul>
</li>
<li>
<p><strong>Reliability</strong>:</p>
<ul>
<li>Use appropriate timeouts for API, backup, and transfer operations</li>
<li>Configure retry attempts for network operations to handle transient failures</li>
<li>Ensure the backup script is idempotent (can be run multiple times safely)</li>
</ul>
</li>
<li>
<p><strong>Performance</strong>:</p>
<ul>
<li>Adjust polling intervals based on how frequently blueprints change</li>
<li>Consider staggering polling for multiple blueprints to avoid overloading the API</li>
</ul>
</li>
<li>
<p><strong>Docker Deployment</strong>:</p>
<ul>
<li>Use volumes for persistent storage of logs and state files</li>
<li>Consider using Docker Compose for easier configuration management</li>
<li>Set up health checks to monitor the application's status</li>
</ul>
</li>
</ol>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="common-issues">Common Issues</h3>
<p><strong>Connection refused when connecting to Apstra server</strong></p>
<ul>
<li>Verify the server address is correct</li>
<li>Ensure network connectivity to the server</li>
<li>Check if the Apstra service is running</li>
</ul>
<p><strong>Authentication failures</strong></p>
<ul>
<li>Verify username and password are correct</li>
<li>Check for expired credentials</li>
<li>Ensure the API user has sufficient permissions</li>
</ul>
<p><strong>Backup script failures</strong></p>
<ul>
<li>Check if the script path is correct</li>
<li>Ensure the script has execute permissions</li>
<li>Verify the script can be run manually</li>
</ul>
<p><strong>Transfer failures</strong></p>
<ul>
<li>Verify remote server address and credentials</li>
<li>Check network connectivity to the remote server</li>
<li>Ensure sufficient disk space on the remote server</li>
</ul>
<h3 id="debug-mode">Debug Mode</h3>
<p>To enable more detailed logging, set the logging level to DEBUG in the configuration:</p>
<pre class="hljs"><code><div><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span> <span class="hljs-string">"DEBUG"</span>
</div></code></pre>
<h2 id="contributing">Contributing</h2>
<p>Contributions are welcome! Please feel free to submit a Pull Request.</p>
<h2 id="license">License</h2>
<p>This project is licensed under the MIT License - see the LICENSE file for details.</p>
<h2 id="acknowledgements">Acknowledgements</h2>
<ul>
<li>The Apstra team for their API documentation</li>
<li>The Python community for excellent libraries</li>
<li>All contributors to this project</li>
</ul>

</body>
</html>
